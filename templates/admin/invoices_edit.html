{% extends "base_dashboard.html" %}
{% block title %}‚úèÔ∏è Rechnung bearbeiten | Ouhud CRM{% endblock %}

{% block content %}
<div class="invoice-edit">

  <!-- üß≠ Kopfbereich -->
  <header class="invoice-header">
    <div>
      <h1>‚úèÔ∏è Rechnung bearbeiten</h1>
      <p>Bearbeite Kundendaten, Positionen und Status mit Live-Berechnung.</p>
    </div>
    <a href="/dashboard/invoices" class="back-link">‚Üê Zur√ºck zur √úbersicht</a>
  </header>

  <!-- üè¢ Firmeninformationen -->
  <section class="company-box">
    <div>
      <h2>{{ company.company_name }}</h2>
      <p>
        {{ company.address }}<br>
        {{ company.city }}, {{ company.country }}<br>
        {{ company.email }}{% if company.phone %} | {{ company.phone }}{% endif %}<br>
        {% if company.vat_number %}USt-IdNr.: {{ company.vat_number }}<br>{% endif %}
        {% if company.iban %}IBAN: {{ company.iban }}{% endif %}
      </p>
    </div>
    {% if company.logo_path %}
      <img src="{{ company.logo_path }}" alt="Logo" class="company-logo">
    {% endif %}
  </section>

  <!-- üßæ Rechnungsdaten -->
  <form method="post" action="/dashboard/invoices/edit/{{ invoice.id }}" class="invoice-form">
    <div class="grid-2">
      <div>
        <label>üë§ Kunde</label>
        <select name="customer_id" required>
          {% for c in customers %}
            <option value="{{ c.id }}" {% if invoice.customer_id == c.id %}selected{% endif %}>{{ c.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label># Rechnungsnummer</label>
        <input type="text" name="invoice_number" value="{{ invoice.invoice_number }}" required>
      </div>
    </div>

    <div class="grid-2">
      <div>
        <label>üí∞ Gesamtbetrag ({{ company.currency_code or 'EUR' }})</label>
        <input type="number" id="total_amount" name="total_amount"
               value="{{ '%.2f'|format(invoice.total_amount) }}" readonly>
      </div>
      <div>
        <label>üìÖ F√§lligkeitsdatum</label>
        <input type="date" name="due_date" value="{{ invoice.due_date }}" required>
      </div>
    </div>

    <div>
      <label>üìå Status</label>
      <select name="status" required>
        <option value="draft" {% if invoice.status == 'draft' %}selected{% endif %}>üìù Entwurf</option>
        <option value="sent" {% if invoice.status == 'sent' %}selected{% endif %}>üì§ Gesendet</option>
        <option value="paid" {% if invoice.status == 'paid' %}selected{% endif %}>‚úÖ Bezahlt</option>
        <option value="cancelled" {% if invoice.status == 'cancelled' %}selected{% endif %}>üö´ Storniert</option>
      </select>
    </div>

    <div class="actions">
      <a href="/dashboard/invoices" class="btn-secondary">‚Üê Abbrechen</a>
      <button type="submit" class="btn-primary">üíæ √Ñnderungen speichern</button>
    </div>
  </form>

  <!-- üìã Rechnungspositionen -->
  <section class="items-section">
    <h2>üìå Rechnungspositionen</h2>

    <form method="post" action="/dashboard/invoices/items/add/{{ invoice.id }}" class="add-item-form">
      <input type="text" name="description" placeholder="Beschreibung" required>
      <input type="number" name="quantity" value="1" min="1" required>
      <input type="number" step="0.01" name="unit_price" placeholder="Preis (‚Ç¨)" required>
      <select name="tax_rate" required>
        <option value="0">0 %</option>
        <option value="7">7 %</option>
        <option value="19">19 %</option>
      </select>
      <button type="submit" class="btn-green">‚ûï Position hinzuf√ºgen</button>
    </form>

    <div class="table-wrap">
      <table id="items-table">
        <thead>
          <tr>
            <th>Beschreibung</th>
            <th>Menge</th>
            <th>Einzelpreis</th>
            <th>MwSt. (%)</th>
            <th class="right">Gesamt</th>
            <th class="right">Aktionen</th>
          </tr>
        </thead>
        <tbody>
          {% for item in invoice.items if item.active %}
          <tr class="item-row" data-id="{{ item.id }}">
            <td>{{ item.description }}</td>
            <td class="qty">{{ item.quantity }}</td>
            <td class="price">{{ "%.2f"|format(item.unit_price) }}</td>
            <td class="tax">{{ item.tax_rate }}</td>
            <td class="right line-total">
              {{ "%.2f"|format(item.quantity * item.unit_price * (1 + item.tax_rate / 100)) }}
            </td>
            <td class="right">
              <form method="post" action="/dashboard/invoices/items/deactivate/{{ item.id }}/{{ invoice.id }}">
                <button type="submit" class="btn-orange" onclick="return confirm('Position stornieren?');">üö´ Stornieren</button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="6" style="text-align:center;color:#6b7280;">üì≠ Keine Positionen vorhanden.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="totals">
      <p><strong>Netto:</strong> <span id="net-total">0.00</span> {{ company.currency_code or 'EUR' }}</p>
      <p><strong>MwSt.:</strong> <span id="tax-total">0.00</span> {{ company.currency_code or 'EUR' }}</p>
      <p class="grand"><strong>üí∞ Gesamt:</strong> <span id="grand-total">0.00</span> {{ company.currency_code or 'EUR' }}</p>
    </div>
  </section>
</div>

<!-- üí° Styles -->
<style>
.invoice-edit { max-width:1100px; margin:auto; font-family:system-ui,sans-serif; color:#1f2937; }
.invoice-header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-bottom:1rem; }
.invoice-header h1 { font-size:1.6rem; font-weight:700; margin:0; }
.invoice-header p { color:#6b7280; margin:0; }
.back-link { color:#4f46e5; text-decoration:none; font-weight:500; }
.back-link:hover { text-decoration:underline; }

.company-box {
  background:white; border-radius:12px; padding:1.2rem;
  box-shadow:0 4px 12px rgba(0,0,0,.05);
  display:flex; justify-content:space-between; align-items:start; gap:1rem; flex-wrap:wrap;
}
.company-box h2 { font-size:1.2rem; margin:0 0 .5rem; }
.company-logo { max-height:64px; border-radius:6px; }

.invoice-form {
  background:white; border-radius:12px; padding:1.4rem 1.6rem;
  box-shadow:0 4px 12px rgba(0,0,0,.05); display:grid; gap:1rem; margin-top:1.2rem;
}
.grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
label { font-weight:600; margin-bottom:.25rem; display:block; }
input, select {
  width:100%; padding:.55rem .7rem; border:1px solid #e5e7eb; border-radius:8px;
  font-size:.95rem; background:white;
}
input[readonly] { background:#f9fafb; }

.actions { display:flex; justify-content:space-between; align-items:center; margin-top:.5rem; }
.btn-primary { background:#4f46e5; color:white; border:none; border-radius:8px; padding:.65rem 1.2rem; cursor:pointer; }
.btn-secondary { color:#555; text-decoration:none; }
.btn-green { background:#10b981; color:white; border:none; border-radius:8px; padding:.55rem 1rem; cursor:pointer; }
.btn-orange { background:#f59e0b; color:white; border:none; border-radius:6px; padding:.4rem .8rem; cursor:pointer; }

.items-section { background:white; border-radius:12px; margin-top:1.5rem; padding:1.4rem 1.6rem; box-shadow:0 4px 12px rgba(0,0,0,.05); }
.add-item-form { display:grid; grid-template-columns:2fr 1fr 1fr 1fr auto; gap:.6rem; margin-bottom:1rem; }
.table-wrap { overflow-x:auto; }
#items-table { width:100%; border-collapse:collapse; font-size:.95rem; }
#items-table th, #items-table td { border-bottom:1px solid #f3f4f6; padding:.6rem .7rem; }
#items-table th { background:#f9fafb; text-align:left; font-weight:600; }
#items-table tr:hover { background:#f9f9ff; }
.right { text-align:right; }

.totals { text-align:right; margin-top:1rem; font-size:1rem; }
.totals .grand { font-size:1.1rem; font-weight:700; }
</style>

<!-- üßÆ Live Berechnung -->
<script>
function updateTotals() {
  let net = 0, tax = 0;
  document.querySelectorAll('#items-table tbody tr.item-row').forEach(row => {
    const qty = parseFloat(row.querySelector('.qty').textContent) || 0;
    const price = parseFloat(row.querySelector('.price').textContent) || 0;
    const rate = parseFloat(row.querySelector('.tax').textContent) || 0;
    const lineNet = qty * price;
    const lineTax = lineNet * (rate / 100);
    net += lineNet; tax += lineTax;
    row.querySelector('.line-total').textContent = (lineNet + lineTax).toFixed(2);
  });
  document.getElementById('net-total').textContent = net.toFixed(2);
  document.getElementById('tax-total').textContent = tax.toFixed(2);
  document.getElementById('grand-total').textContent = (net + tax).toFixed(2);
  document.getElementById('total_amount').value = (net + tax).toFixed(2);
}
document.addEventListener('DOMContentLoaded', updateTotals);
</script>
{% endblock %}