{% extends "base_dashboard.html" %} {% block title %}üìä Audit Logs ‚Äì Ouhud CRM{%
endblock %} {% block content %}

<div class="audit-wrapper">
  <!-- ===================================================== -->
  <!-- KPI TOP BAR -->
  <!-- ===================================================== -->
  <div class="kpi-row">
    <div class="kpi-box kpi-blue">
      <div class="kpi-title">Gesamt Logs</div>
      <div class="kpi-value">{{ logs|length }}</div>
    </div>

    <div class="kpi-box kpi-green">
      <div class="kpi-title">Logins</div>
      <div class="kpi-value">{{ stats.logins }}</div>
    </div>

    <div class="kpi-box kpi-orange">
      <div class="kpi-title">√Ñnderungen</div>
      <div class="kpi-value">{{ stats.changes }}</div>
    </div>

    <div class="kpi-box kpi-red">
      <div class="kpi-title">Fehler / Warnungen</div>
      <div class="kpi-value">{{ stats.errors }}</div>
    </div>
  </div>

  <!-- ===================================================== -->
  <!-- FILTER BAR -->
  <!-- ===================================================== -->
  <div class="filter-bar">
    <form method="get" class="filter-form">
      <input
        type="text"
        name="q"
        placeholder="üîç Suche‚Ä¶"
        value="{{ request.query_params.get('q','') }}"
      />

      <select name="action">
        <option value="">Aktion w√§hlen</option>
        <option value="login">Login</option>
        <option value="logout">Logout</option>
        <option value="create">Erstellt</option>
        <option value="update">Aktualisiert</option>
        <option value="delete">Gel√∂scht</option>
        <option value="error">Fehler</option>
      </select>

      <select name="range">
        <option value="">Zeitraum</option>
        <option value="today">Heute</option>
        <option value="7">Letzte 7 Tage</option>
        <option value="30">Letzte 30 Tage</option>
      </select>

      <button class="btn-filter">Filtern</button>
    </form>

    <a href="/dashboard/audit/export" class="btn-export">‚¨áÔ∏è Export CSV</a>
  </div>

  <!-- ===================================================== -->
  <!-- LOG TABLE -->
  <!-- ===================================================== -->
  <div style="overflow-x: auto">
    <table class="audit-table">
      <thead>
        <tr>
          <th>Datum</th>
          <th>Benutzer</th>
          <th>Aktion</th>
          <th>Details</th>
          <th>IP</th>
        </tr>
      </thead>

      <tbody>
        {% if logs %} {% for log in logs %}
        <tr onclick="showDetails('{{ log.id }}')">
          <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
          <td>{{ log.user }}</td>
          <td>
            <span class="tag tag-{{ log.action }}">
              {{ log.action|capitalize }}
            </span>
          </td>
          <td class="truncate">{{ log.details }}</td>
          <td>{{ log.ip_address }}</td>
        </tr>
        {% endfor %} {% else %}
        <tr>
          <td colspan="5" class="empty">üì≠ Keine Audit-Eintr√§ge vorhanden.</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- ===================================================== -->
<!-- MODAL F√úR DETAILS -->
<!-- ===================================================== -->
<div id="auditModal" class="modal hidden">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal()">‚úñ</button>
    <h2>Log Details</h2>
    <pre id="modal-details"></pre>
  </div>
</div>

<style>
  /* ---------- LAYOUT ---------- */
  .audit-wrapper {
    max-width: 1100px;
    margin: 1.5rem auto;
  }

  /* ---------- KPI ---------- */
  .kpi-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .kpi-box {
    padding: 1rem;
    border-radius: 12px;
    color: white;
  }

  .kpi-blue {
    background: #2563eb;
  }
  .kpi-green {
    background: #16a34a;
  }
  .kpi-orange {
    background: #f59e0b;
  }
  .kpi-red {
    background: #dc2626;
  }

  .kpi-title {
    font-size: 0.9rem;
    opacity: 0.85;
  }
  .kpi-value {
    font-size: 1.8rem;
    font-weight: 700;
  }

  /* ---------- FILTER ---------- */
  .filter-bar {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.8rem;
  }

  .filter-form {
    display: flex;
    gap: 0.5rem;
  }

  .filter-form input,
  .filter-form select {
    padding: 0.5rem 0.7rem;
    border-radius: 8px;
    border: 1px solid #ddd;
  }

  .btn-filter {
    padding: 0.5rem 1rem;
    background: #0d2a78;
    color: white;
    border-radius: 8px;
    border: none;
    cursor: pointer;
  }

  .btn-export {
    padding: 0.5rem 1rem;
    background: #2563eb;
    color: white;
    border-radius: 8px;
    text-decoration: none;
  }

  /* ---------- TABLE ---------- */
  .audit-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 12px;
    overflow: hidden;
  }

  .audit-table th,
  .audit-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #eee;
  }

  .audit-table tr:hover {
    background: #f9fafb;
    cursor: pointer;
  }

  .truncate {
    max-width: 240px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Action Tags */
  .tag {
    padding: 0.2rem 0.5rem;
    border-radius: 6px;
    font-size: 0.75rem;
    color: white;
  }
  .tag-login {
    background: #2563eb;
  }
  .tag-logout {
    background: #6b7280;
  }
  .tag-create {
    background: #16a34a;
  }
  .tag-update {
    background: #f59e0b;
  }
  .tag-delete {
    background: #dc2626;
  }
  .tag-error {
    background: #b91c1c;
  }

  /* ---------- MODAL ---------- */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.45);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .modal.hidden {
    display: none;
  }

  .modal-content {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    width: 460px;
    max-height: 70vh;
    overflow: auto;
    position: relative;
  }

  .modal-close {
    position: absolute;
    right: 12px;
    top: 12px;
    cursor: pointer;
    background: none;
    border: none;
    font-size: 1.2rem;
  }

  .empty {
    text-align: center;
    padding: 1.5rem;
    color: #888;
  }
</style>

<script>
  function showDetails(id) {
    fetch(`/dashboard/audit/details/${id}`)
      .then((res) => res.json())
      .then((data) => {
        document.getElementById("modal-details").textContent = JSON.stringify(
          data,
          null,
          2
        );
        document.getElementById("auditModal").classList.remove("hidden");
      });
  }

  function closeModal() {
    document.getElementById("auditModal").classList.add("hidden");
  }
</script>

{% endblock %}
