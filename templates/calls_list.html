{% extends "base_dashboard.html" %}
{% block title %}ğŸ“ Telefonie â€“ Ouhud CRM{% endblock %}

{% block content %}
<style>
  :root {
    --primary: #0D2A78;
    --primary-dark: #1E40AF;
    --success: #10B981;
    --danger: #dc2626;
    --border: #e5e7eb;
    --bg: #f4f6f8;
    --text: #1f2937;
    --muted: #6b7280;
  }

  h1 {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 1rem;
  }

  .tab-btn {
    background: none;
    border: none;
    padding: 0.6rem 1rem;
    font-size: 1rem;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    color: var(--text);
    transition: all 0.2s ease;
  }

  .tab-btn:hover {
    color: var(--primary);
    background: rgba(13,42,120,0.05);
  }

  .tab-btn.active {
    border-bottom-color: var(--primary);
    font-weight: 600;
    color: var(--primary);
  }

  .tab-content {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    padding: 1rem;
  }

  input, select, textarea {
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.55rem 0.75rem;
    font-size: 0.95rem;
    width: 100%;
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(13,42,120,0.1);
    outline: none;
  }

  button {
    background: var(--primary);
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 0.6rem 1rem;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.25s ease;
  }

  button:hover {
    background: var(--primary-dark);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.94rem;
  }

  th, td {
    padding: 0.65rem;
    border-bottom: 1px solid var(--border);
  }

  th {
    background: var(--bg);
    color: var(--primary-dark);
    font-weight: 600;
    text-align: left;
  }

  tr:hover td {
    background: #f9fafb;
  }

  .status-pill {
    padding: 0.25rem 0.6rem;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    display: inline-block;
  }

  .status-success { background: #dcfce7; color: #166534; }
  .status-error { background: #fee2e2; color: #991b1b; }
  .status-neutral { background: #f1f5f9; color: #334155; }

  .btn-success {
    background: var(--success);
  }

  .btn-success:hover {
    background: #059669;
  }
</style>

<div style="max-width:1100px;margin:0 auto;">
  <h1>ğŸ“ Telefonie</h1>

  <!-- ğŸ§­ Tabs -->
  <div style="display:flex;gap:1rem;margin-bottom:1rem;border-bottom:2px solid var(--border);">
    <button class="tab-btn active" data-tab="calls">ğŸ“‹ Anrufliste</button>
    <button class="tab-btn" data-tab="settings">âš™ï¸ Telefoneinstellungen</button>
  </div>

  <!-- ğŸ“‹ TAB: Anrufliste -->
  <div id="tab-calls" class="tab-content active">
    <!-- ğŸ” Filter -->
    <form method="get" action="/dashboard/calls" 
          style="display:grid;grid-template-columns:1fr 180px 100px;gap:.6rem;margin-bottom:1rem;">
      <input type="text" name="q" 
             placeholder="ğŸ” Nach Nummer oder Name suchenâ€¦" 
             value="{{ request.query_params.get('q','') }}">
      <select name="status">
        <option value="">Alle Status</option>
        <option value="completed">âœ… Erfolgreich</option>
        <option value="missed">âŒ Verpasst</option>
        <option value="rejected">ğŸš« Abgelehnt</option>
      </select>
      <button type="submit">Filtern</button>
    </form>

    <!-- ğŸ“ Tabelle -->
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Richtung</th>
            <th>Nummer</th>
            <th>Name</th>
            <th>Zeit</th>
            <th>Dauer</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% if calls %}
            {% for call in calls %}
            <tr>
              <td>{{ call.id }}</td>
              <td>
                {% if call.direction == 'inbound' %}
                  ğŸ“¥ Eingehend
                {% else %}
                  ğŸ“¤ Ausgehend
                {% endif %}
              </td>
              <td>{{ call.phone_number }}</td>
              <td>{{ call.contact_name or '-' }}</td>
              <td>{{ call.timestamp.strftime('%d.%m.%Y %H:%M') }}</td>
              <td>{{ call.duration or 0 }} s</td>
              <td>
                {% if call.status == 'completed' %}
                  <span class="status-pill status-success">âœ… Erfolgreich</span>
                {% elif call.status == 'missed' %}
                  <span class="status-pill status-error">âŒ Verpasst</span>
                {% else %}
                  <span class="status-pill status-neutral">ğŸš« Abgelehnt</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" style="text-align:center;padding:1rem;color:var(--muted);">
                ğŸ“­ Keine Anrufe gefunden.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- â• Formular -->
    <h2 style="font-size:1.2rem;font-weight:600;margin-top:2rem;color:var(--primary-dark);">
      â• Neuen Anruf eintragen
    </h2>
    <form method="post" action="/dashboard/calls/add" 
          style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.6rem;margin-top:.6rem;">
      <input type="text" name="phone_number" placeholder="Nummer" required>
      <select name="direction">
        <option value="inbound">ğŸ“¥ Eingehend</option>
        <option value="outbound">ğŸ“¤ Ausgehend</option>
      </select>
      <input type="text" name="contact_name" placeholder="Name (optional)">
      <input type="number" name="duration" placeholder="Sekunden" min="0">
      <select name="status">
        <option value="completed">âœ… Erfolgreich</option>
        <option value="missed">âŒ Verpasst</option>
        <option value="rejected">ğŸš« Abgelehnt</option>
      </select>
      <button type="submit">â• HinzufÃ¼gen</button>
    </form>
  </div>

  <!-- âš™ï¸ TAB: Telefoneinstellungen -->
  <div id="tab-settings" class="tab-content" style="display:none;">
    <h2 style="font-size:1.2rem;font-weight:600;margin-bottom:.8rem;color:var(--primary-dark);">
      âš™ï¸ Telefoneinstellungen
    </h2>
    <form method="post" action="/dashboard/calls/settings/save" style="display:flex;flex-direction:column;gap:.8rem;">
      <label>
        Anbieter:
        <select name="provider" required>
          <option value="twilio" {% if settings and settings.provider == 'twilio' %}selected{% endif %}>Twilio</option>
          <option value="fritzbox" {% if settings and settings.provider == 'fritzbox' %}selected{% endif %}>FritzBox</option>
          <option value="placetel" {% if settings and settings.provider == 'placetel' %}selected{% endif %}>Placetel</option>
          <option value="custom" {% if settings and settings.provider == 'custom' %}selected{% endif %}>Custom</option>
        </select>
      </label>

      <label>API-URL:
        <input type="text" name="api_url" value="{{ settings.api_url if settings else '' }}" required>
      </label>

      <label>API-Key / Token:
        <input type="text" name="api_key" value="{{ settings.api_key if settings else '' }}">
      </label>

      <label>SIP-Benutzername:
        <input type="text" name="sip_user" value="{{ settings.sip_user if settings else '' }}">
      </label>

      <label>SIP-Passwort:
        <input type="password" name="sip_password" value="{{ settings.sip_password if settings else '' }}">
      </label>

      <div style="display:flex;gap:.6rem;margin-top:.6rem;">
        <button type="submit">ğŸ’¾ Speichern</button>
        <a href="/dashboard/calls/settings/test"
           class="btn-success"
           style="text-decoration:none;display:inline-block;padding:.6rem 1rem;border-radius:8px;">
          ğŸ”Œ Verbindung testen
        </a>
      </div>
    </form>
  </div>
</div>

<script>
  const tabs = document.querySelectorAll('.tab-btn');
  const contents = document.querySelectorAll('.tab-content');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const target = tab.dataset.tab;
      contents.forEach(c => c.style.display = c.id === 'tab-' + target ? 'block' : 'none');
    });
  });
</script>
{% endblock %}