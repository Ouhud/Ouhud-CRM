{% extends "base_dashboard.html" %}
{% block title %}Dashboard â€“ Ouhud CRM{% endblock %}

{% block content %}
<h1 style="color:#0D2A78;margin-bottom:0.5rem;">Dashboard</h1>
<p>Willkommen im Ouhud CRM â€“ Ãœberblick Ã¼ber aktuelle Kennzahlen und Entwicklungen.</p>

<!-- ğŸŒŸ KPI-Karten -->
<div class="kpi-grid">
  <div class="kpi-card"><h3>Gesamtumsatz</h3><p>{{ stats.total_sum | round(2) }} {{ company.currency_code or 'EUR' }}</p></div>
  <div class="kpi-card"><h3>Kunden</h3><p>{{ stats.customers }}</p></div>
  <div class="kpi-card"><h3>Rechnungen</h3><p>{{ stats.invoices }}</p></div>
  <div class="kpi-card"><h3>ÃœberfÃ¤llig</h3><p>{{ stats.overdue }}</p></div>
</div>

<!-- ğŸ§© Dashboard-Gitter -->
<div class="dashboard-grid">
  <div class="card chart-card">
    <h2>ğŸ“ˆ Umsatzentwicklung</h2>
    <canvas id="umsatzChart"></canvas>
  </div>

  <div class="card chart-card">
    <h2>ğŸ‘¥ KundenÃ¼bersicht</h2>
    <canvas id="kundenChart"></canvas>
  </div>

  <div class="card chart-card">
    <h2>ğŸš€ Leads nach Status</h2>
    <canvas id="leadsChart"></canvas>
  </div>

  <div class="card chart-card">
    <h2>ğŸ§¾ Offene Rechnungen nach FÃ¤lligkeit</h2>
    <canvas id="invoiceChart"></canvas>
  </div>

  <div class="card chart-card">
    <h2>ğŸ“¦ Top-Produkte nach Umsatz</h2>
    <canvas id="productChart"></canvas>
  </div>

  <div class="card chart-card">
    <h2>ğŸ’³ ZahlungseingÃ¤nge pro Monat</h2>
    <canvas id="paymentChart"></canvas>
  </div>
</div>

<style>
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
  gap: 1rem;
  margin-top: 1rem;
}
.kpi-card {
  background: linear-gradient(135deg,#0D2A78,#1E40AF);
  color: white;
  padding: 1rem;
  border-radius: 0.8rem;
  text-align: center;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}
.kpi-card h3 {font-size:0.9rem;margin:0;}
.kpi-card p {font-size:1.5rem;margin:0.3rem 0 0;font-weight:bold;}

.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit,minmax(340px,1fr));
  gap: 1.5rem;
  margin-top: 2rem;
}
.card {
  background: white;
  border-radius: 1rem;
  padding: 1.5rem;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}
h2 {
  font-size:1rem;
  margin-bottom:0.8rem;
  color:#0D2A78;
}
.chart-card {
  height:320px;
  display:flex;
  flex-direction:column;
}
.chart-card canvas {
  width:100%!important;
  height:240px!important;
}
</style>
{% endblock %}
{% block scripts %}
<!-- ğŸ“Š Chart.js laden -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
function renderDashboardCharts() {
  console.log("ğŸ“ˆ Dashboard Charts werden gerendert...");

  // ğŸŸ¢ 1ï¸âƒ£ Umsatzentwicklung
  new Chart(document.getElementById("umsatzChart"), {
    type: "line",
    data: {
      labels: {{ chart_data.months | tojson }},
      datasets: [{
        label: "Umsatz ({{ company.currency_code or 'EUR' }})",
        data: {{ chart_data.revenues | tojson }},
        borderColor: "#0D2A78",
        backgroundColor: "rgba(13,42,120,0.1)",
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: "bottom" } },
      scales: { y: { beginAtZero: true } }
    }
  });

  // ğŸŸ¢ 2ï¸âƒ£ KundenÃ¼bersicht
  new Chart(document.getElementById("kundenChart"), {
    type: "doughnut",
    data: {
      labels: ["Aktiv", "Neu", "Inaktiv"],
      datasets: [{
        data: [120, 30, 15],
        backgroundColor: ["#0D2A78", "#1E40AF", "#93C5FD"],
        borderWidth: 0
      }]
    },
    options: {
      maintainAspectRatio: false,
      cutout: "70%",
      plugins: { legend: { position: "bottom" } }
    }
  });

  // ğŸŸ¢ 3ï¸âƒ£ Leads nach Status
  new Chart(document.getElementById("leadsChart"), {
    type: "bar",
    data: {
      labels: Object.keys({{ chart_data.leads | tojson }}),
      datasets: [{
        label: "Leads",
        data: Object.values({{ chart_data.leads | tojson }}),
        backgroundColor: "#0D2A78",
        borderRadius: 6
      }]
    },
    options: {
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } },
      plugins: { legend: { display: false } }
    }
  });

  // ğŸŸ¢ 4ï¸âƒ£ Offene Rechnungen nach FÃ¤lligkeit
  new Chart(document.getElementById("invoiceChart"), {
    type: "bar",
    data: {
      labels: ["0â€“30 Tage", "31â€“60 Tage", "61â€“90 Tage", ">90 Tage"],
      datasets: [{
        label: "Rechnungen",
        data: [10, 6, 3, 2],
        backgroundColor: "#F59E0B",
        borderRadius: 6
      }]
    },
    options: {
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } },
      plugins: { legend: { position: "bottom" } }
    }
  });

  // ğŸŸ¢ 5ï¸âƒ£ Top-Produkte nach Umsatz
  new Chart(document.getElementById("productChart"), {
    type: "bar",
    data: {
      labels: {{ chart_data.products | tojson }},
      datasets: [{
        label: "Umsatz ({{ company.currency_code or 'EUR' }})",
        data: {{ chart_data.product_sales | tojson }},
        backgroundColor: "#10B981"
      }]
    },
    options: {
      indexAxis: "y",
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { x: { beginAtZero: true } }
    }
  });

  // ğŸŸ¢ 6ï¸âƒ£ ZahlungseingÃ¤nge pro Monat
  new Chart(document.getElementById("paymentChart"), {
    type: "line",
    data: {
      labels: {{ chart_data.payments["labels"] | tojson }},
      datasets: [{
        label: "Zahlungen ({{ company.currency_code or 'EUR' }})",
        data: {{ chart_data.payments["values"] | tojson }},
        borderColor: "#0D9488",
        backgroundColor: "rgba(13,148,136,0.1)",
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: "bottom" } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

// ğŸš€ Initialisierung nach Laden der Seite
document.addEventListener("DOMContentLoaded", renderDashboardCharts);
</script>
{% endblock %}