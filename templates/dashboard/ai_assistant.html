{% extends "base_dashboard.html" %}
{% block title %}ğŸ¤– Ouhud KI-Assistent | CRM{% endblock %}

{% block content %}
<div class="wrap" style="max-width:960px; margin:2rem auto; padding:0 1rem;">
  <div class="card" style="background:#fff; border-radius:16px; box-shadow:0 8px 28px rgba(0,0,0,0.08); display:flex; flex-direction:column; height:75vh;">

    <!-- ğŸ§­ Header -->
    <div class="card-header" style="display:flex; align-items:center; justify-content:space-between; padding:1rem 1.25rem; border-bottom:1px solid #e5e7eb;">
      <div style="display:flex; align-items:center; gap:.75rem;">
        <img src="/static/logo-assistant.png" alt="AI" style="width:36px; height:36px; border-radius:50%;">
        <h1 style="font-size:1.2rem; font-weight:600; margin:0;">Ouhud KI-Assistent</h1>
        <span class="badge" style="background:#eef2ff; color:#4f46e5; font-size:.8rem; padding:.2rem .6rem; border-radius:999px;">Beta</span>
      </div>

  <a href="/dashboard/ai/settings" class="ai-settings-btn">âš™ï¸ Einstellungen</a>
    </div>

    <!-- ğŸ’¬ Chatbereich -->
    <div id="chat" class="card-body" style="flex:1; overflow-y:auto; background:#fafafa; padding:1rem 1.25rem;">
      {% if error %}
        <div class="system err" style="text-align:center; font-size:.85rem; color:#b91c1c;">âš ï¸ {{ error }}</div>
      {% else %}
        <div class="system" style="text-align:center; font-size:.85rem; color:#6b7280;">
          ğŸ‘‹ Hallo! Ich bin dein Ouhud KI-Assistent. Stelle mir Fragen rund um CRM, Kunden, Rechnungen oder Automatisierungen.
        </div>
      {% endif %}
    </div>

    <!-- ğŸ“ Eingabebereich -->
    <div class="card-footer" style="display:flex; gap:.5rem; padding:.75rem; border-top:1px solid #e5e7eb; background:white;">
      <textarea id="input" placeholder="Nachricht eingebenâ€¦" 
        style="flex:1; resize:none; border:1px solid #ddd; border-radius:12px; padding:.7rem; font:inherit; height:56px;"></textarea>
      <button id="send" 
        style="background:#4f46e5; color:#fff; border:none; border-radius:12px; padding:0 1.25rem; font-weight:500; cursor:pointer;">
        Senden
      </button>
    </div>
  </div>

  <div class="system" style="font-size:.8rem; text-align:center; color:#6b7280; margin-top:.5rem;">
    ğŸ’¡ Tipp: Frage z. B. â€Wie lege ich eine neue Rechnung an?â€œ oder â€Zeig mir Ideen fÃ¼r Zahlungserinnerungenâ€œ.
  </div>
</div>

<!-- ğŸ’¬ Chat Script -->
<script>
  const chat  = document.getElementById('chat');
  const input = document.getElementById('input');
  const send  = document.getElementById('send');

  function escapeHtml(t) {
    return t.replace(/[&<>"']/g, s => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
    }[s]));
  }

  function addMsg(role, text) {
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + (role === 'user' ? 'me' : 'bot');
    wrap.style.margin = '.75rem 0';
    wrap.innerHTML = `
      <div class="who" style="font-size:.8rem; color:#6b7280;">${role === 'user' ? 'Du' : 'Assistent'}</div>
      <div class="bubble" style="display:inline-block; padding:.6rem .8rem; border-radius:14px; max-width:80%; white-space:pre-wrap; background:${role === 'user' ? '#e5e7eb' : '#e0e7ff'};">${escapeHtml(text)}</div>
    `;
    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;
  }

  async function ask() {
    const message = input.value.trim();
    if (!message) return;
    addMsg('user', message);
    input.value = '';
    send.disabled = true; send.textContent = 'â€¦';

    try {
      const res = await fetch('/dashboard/ai/query', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ message })
      });
      const data = await res.json();
      addMsg('assistant', data.reply || 'âš ï¸ Fehler');
    } catch (e) {
      addMsg('assistant', 'âš ï¸ Netzwerkfehler: ' + e);
    } finally {
      send.disabled = false; send.textContent = 'Senden';
    }
  }

  send.addEventListener('click', ask);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      ask();
    }
  });
</script>

<!-- âš™ï¸ Settings Button CSS -->
<style>
.ai-settings-btn {
  margin-left:auto;
  display:inline-flex;
  align-items:center;
  gap:.25rem;
  background:#eef2ff;
  color:#4f46e5;
  padding:.35rem .75rem;
  border-radius:8px;
  font-size:.85rem;
  text-decoration:none;
  transition: background .2s;
}
.ai-settings-btn:hover {
  background:#e0e7ff;
}
</style>
{% endblock %}