{% extends "base_dashboard.html" %}
{% block title %}ü§ñ Ouhud KI-Assistent | CRM{% endblock %}

{% block content %}
<div class="ai-chat-container">
  <div class="ai-card">

    <!-- üß≠ Header -->
    <header class="ai-header">
      <div class="ai-header-left">
        <img src="/static/logo-assistant.png" alt="AI" class="ai-logo">
        <h1>Ouhud KI-Assistent</h1>
        <span class="ai-badge">Beta</span>
      </div>
      <a href="/dashboard/ai/settings" class="ai-settings-btn">‚öôÔ∏è Einstellungen</a>
    </header>

    <!-- üí¨ Chatbereich -->
    <main id="chat" class="ai-chat-body">
      {% if error %}
        <div class="ai-system-error">‚ö†Ô∏è {{ error }}</div>
      {% else %}
        <div class="ai-system-intro">
          üëã Hallo! Ich bin dein Ouhud KI-Assistent.<br>
          Stelle mir Fragen rund um CRM, Kunden, Rechnungen oder Automatisierungen.
        </div>
      {% endif %}
    </main>

    <!-- üìù Eingabebereich -->
    <footer class="ai-footer">
      <textarea id="input" placeholder="Nachricht eingeben‚Ä¶" rows="2"></textarea>
      <button id="send">Senden</button>
    </footer>
  </div>

  <p class="ai-tip">
    üí° Tipp: Frage z.&nbsp;B. ‚ÄûWie lege ich eine neue Rechnung an?‚Äú oder ‚ÄûZeig mir Ideen f√ºr Zahlungserinnerungen‚Äú.
  </p>
</div>

<style>
  :root {
    --primary: #0D2A78;
    --primary-light: #eef2ff;
    --primary-hover: #e0e7ff;
    --border: #e5e7eb;
    --bg: #fafafa;
    --text: #1f2937;
  }

  .ai-chat-container {
    max-width: 960px;
    margin: 2rem auto;
    padding: 0 1rem;
  }

  .ai-card {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.06);
    display: flex;
    flex-direction: column;
    height: 75vh;
    overflow: hidden;
  }

  /* Header */
  .ai-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border);
    background: #fff;
  }

  .ai-header-left {
    display: flex;
    align-items: center;
    gap: .75rem;
  }

  .ai-logo {
    width: 36px;
    height: 36px;
    border-radius: 50%;
  }

  .ai-header h1 {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--primary);
    margin: 0;
  }

  .ai-badge {
    background: var(--primary-light);
    color: var(--primary);
    font-size: .8rem;
    padding: .2rem .6rem;
    border-radius: 999px;
  }

  .ai-settings-btn {
    display: inline-flex;
    align-items: center;
    background: var(--primary-light);
    color: var(--primary);
    padding: .4rem .8rem;
    border-radius: 8px;
    font-size: .85rem;
    text-decoration: none;
    transition: background .2s;
  }

  .ai-settings-btn:hover {
    background: var(--primary-hover);
  }

  /* Chatbereich */
  .ai-chat-body {
    flex: 1;
    background: var(--bg);
    padding: 1rem 1.25rem;
    overflow-y: auto;
    scroll-behavior: smooth;
  }

  .ai-system-intro,
  .ai-system-error {
    text-align: center;
    font-size: .9rem;
    color: #6b7280;
    margin-top: 1rem;
  }

  .ai-system-error {
    color: #b91c1c;
  }

  /* Nachrichten */
  .msg {
    margin: .75rem 0;
  }

  .msg .who {
    font-size: .8rem;
    color: #6b7280;
    margin-bottom: .25rem;
  }

  .msg .bubble {
    display: inline-block;
    padding: .65rem .9rem;
    border-radius: 14px;
    max-width: 80%;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .msg.me .bubble {
    background: #e5e7eb;
    align-self: flex-end;
  }

  .msg.bot .bubble {
    background: var(--primary-light);
    color: var(--text);
  }

  /* Eingabe */
  .ai-footer {
    display: flex;
    gap: .5rem;
    padding: .8rem;
    border-top: 1px solid var(--border);
    background: #fff;
  }

  .ai-footer textarea {
    flex: 1;
    resize: none;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: .7rem;
    font: inherit;
    height: 56px;
  }

  .ai-footer button {
    background: var(--primary);
    color: #fff;
    border: none;
    border-radius: 12px;
    padding: 0 1.25rem;
    font-weight: 600;
    cursor: pointer;
    transition: background .2s;
  }

  .ai-footer button:hover {
    background: #1E3A8A;
  }

  /* Tipp */
  .ai-tip {
    font-size: .8rem;
    text-align: center;
    color: #6b7280;
    margin-top: .75rem;
  }

  @media (max-width: 700px) {
    .ai-card { height: 70vh; }
    .ai-footer textarea { height: 48px; }
  }
</style>

<!-- üí¨ Chat Script -->
<script>
  const chat  = document.getElementById('chat');
  const input = document.getElementById('input');
  const send  = document.getElementById('send');

  function escapeHtml(t) {
    return t.replace(/[&<>"']/g, s => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
    }[s]));
  }

  function addMsg(role, text) {
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + (role === 'user' ? 'me' : 'bot');
    wrap.innerHTML = `
      <div class="who">${role === 'user' ? 'Du' : 'Assistent'}</div>
      <div class="bubble">${escapeHtml(text)}</div>
    `;
    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;
  }

  async function ask() {
    const message = input.value.trim();
    if (!message) return;
    addMsg('user', message);
    input.value = '';
    send.disabled = true; send.textContent = '‚Ä¶';

    try {
      const res = await fetch('/dashboard/ai/query', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ message })
      });
      const data = await res.json();
      addMsg('assistant', data.reply || '‚ö†Ô∏è Keine Antwort erhalten.');
    } catch (e) {
      addMsg('assistant', '‚ö†Ô∏è Netzwerkfehler: ' + e);
    } finally {
      send.disabled = false; send.textContent = 'Senden';
    }
  }

  send.addEventListener('click', ask);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      ask();
    }
  });
</script>
{% endblock %}