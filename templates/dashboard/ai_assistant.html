{% extends "base_dashboard.html" %} {% block title %}ü§ñ KI-Assistent | Ouhud
CRM{% endblock %} {% block content %}

<div class="ai-wrapper">
  <!-- HEADER -->
  <header class="ai-header">
    <div class="ai-left">
      <img src="/static/img/ai-avatar.png" class="ai-avatar" alt="AI" />
      <div>
        <h1>Ouhud KI-Assistent</h1>
        <span class="ai-provider-badge" id="provider-badge">‚ö° KI aktiv</span>
      </div>
    </div>

    <a href="/dashboard/ai/settings" class="ai-settings-btn"
      >‚öôÔ∏è Einstellungen</a
    >
  </header>

  <!-- QUICK TOOLS -->
  <div class="ai-tools-grid">
    <button onclick="preset('Bitte diesen Text professionell umschreiben: ')">
      ‚úçÔ∏è Umschreiben
    </button>
    <button onclick="preset('Bitte folgende Inhalte zusammenfassen: ')">
      üìÑ Zusammenfassen
    </button>
    <button onclick="preset('Bitte erstelle eine professionelle E-Mail: ')">
      üíº E-Mail erstellen
    </button>
    <button onclick="preset('Bitte generiere eine Antwort f√ºr einen Kunden: ')">
      üí¨ Kundenantwort
    </button>
    <button onclick="preset('Erkl√§re diese Rechnung: ')">
      üìä Rechnung erkl√§ren
    </button>
    <button onclick="preset('Bitte korrigiere Grammatik und Formulierung: ')">
      üßº Text verbessern
    </button>
  </div>

  <!-- CHAT -->
  <main id="chat" class="ai-chat-body">
    {% if error %}
    <div class="ai-system-error">‚ö†Ô∏è {{ error }}</div>
    {% else %}
    <div class="ai-welcome">
      üëã Hallo {{ user.first_name or user.email }}! Ich bin dein pers√∂nlicher
      KI-Assistent f√ºr Ouhud CRM.<br />
      Stelle mir Fragen zu Kunden, Rechnungen, Automatisierungen oder
      Gesch√§ftsprozessen.
    </div>
    {% endif %}
  </main>

  <!-- INPUT -->
  <footer class="ai-footer">
    <textarea id="input" placeholder="Frage eingeben‚Ä¶" rows="2"></textarea>
    <button id="send">Senden</button>
  </footer>

  <!-- TOKEN INFO -->
  <div id="usage-info" class="ai-usage hidden">
    <span id="usage-tokens"></span>
    <span id="usage-cost"></span>
  </div>
</div>

<!-- ======================================================================= -->
<!-- CSS -->
<!-- ======================================================================= -->
<style>
  :root {
    --blue: #0d2a78;
    --blue-light: #eef3ff;
    --blue-hover: #dfe7ff;
    --border: #e5e7eb;
    --bg: #fafafa;
  }

  .ai-wrapper {
    max-width: 900px;
    margin: 2rem auto;
    background: white;
    border-radius: 18px;
    box-shadow: 0 6px 22px rgba(0, 0, 0, 0.06);
    height: 80vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* HEADER */
  .ai-header {
    padding: 1rem 1.4rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
  }
  .ai-left {
    display: flex;
    gap: 1rem;
    align-items: center;
  }
  .ai-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
  }
  .ai-provider-badge {
    background: var(--blue-light);
    padding: 0.2rem 0.6rem;
    border-radius: 999px;
  }
  .ai-settings-btn {
    background: var(--blue-light);
    padding: 0.5rem 0.8rem;
    border-radius: 8px;
    text-decoration: none;
    color: var(--blue);
    font-weight: 600;
  }

  /* QUICK TOOLS ‚Äì GRID LAYOUT */
  .ai-tools-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.8rem;
    padding: 1rem;
    background: #f7f8ff;
    border-bottom: 1px solid var(--border);
  }

  .ai-tools-grid button {
    padding: 1rem;
    background: white;
    border-radius: 12px;
    border: 1px solid #dce2ff;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    transition: 0.25s;
  }

  .ai-tools-grid button:hover {
    background: var(--blue-light);
    border-color: var(--blue);
    transform: translateY(-2px);
  }

  /* RESPONSIVE */
  @media (max-width: 900px) {
    .ai-tools-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  @media (max-width: 600px) {
    .ai-tools-grid {
      grid-template-columns: repeat(1, 1fr);
    }
  }

  /* CHAT */
  .ai-chat-body {
    padding: 1.2rem;
    background: var(--bg);
    flex: 1;
    overflow-y: auto;
  }
  .msg {
    margin: 1rem 0;
    display: flex;
    flex-direction: column;
  }
  .msg .bubble {
    padding: 0.8rem 1rem;
    border-radius: 14px;
    max-width: 80%;
    white-space: pre-wrap;
  }
  .msg.me .bubble {
    background: #e5e7eb;
    align-self: flex-end;
  }
  .msg.bot .bubble {
    background: var(--blue-light);
  }

  /* INPUT */
  .ai-footer {
    display: flex;
    padding: 0.9rem;
    gap: 0.6rem;
    border-top: 1px solid var(--border);
  }
  .ai-footer textarea {
    flex: 1;
    border-radius: 14px;
    border: 1px solid var(--border);
    padding: 0.7rem;
  }
  .ai-footer button {
    background: var(--blue);
    color: white;
    border-radius: 14px;
    padding: 0 1.2rem;
    border: none;
  }

  /* TOKENS */
  .ai-usage {
    text-align: right;
    padding: 0.4rem 1rem;
  }
  .hidden {
    display: none;
  }
</style>

<!-- ======================================================================= -->
<!-- SCRIPT (Streaming) -->
<!-- ======================================================================= -->
<script>
  const chat = document.getElementById("chat");
  const input = document.getElementById("input");
  const send = document.getElementById("send");

  function preset(text) {
    input.value = text;
    input.focus();
  }

  function addMsg(role, text) {
    const el = document.createElement("div");
    el.className = "msg " + (role === "user" ? "me" : "bot");
    el.innerHTML = `
        <div class="who">${role === "user" ? "Du" : "Assistent"}</div>
        <div class="bubble">${text}</div>
    `;
    chat.appendChild(el);
    chat.scrollTop = chat.scrollHeight;
  }

  async function ask() {
    const message = input.value.trim();
    if (!message) return;

    addMsg("user", message);
    input.value = "";
    send.disabled = true;

    const wrap = document.createElement("div");
    wrap.className = "msg bot";
    wrap.innerHTML = `<div class="who">Assistent</div><div class="bubble" id="stream-bubble"></div>`;
    chat.appendChild(wrap);
    const target = document.getElementById("stream-bubble");

    const res = await fetch("/dashboard/ai/stream", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message }),
    });

    const reader = res.body.getReader();
    const decoder = new TextDecoder();

    let full = "";

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value);
      const lines = chunk.split("\n");

      for (const l of lines) {
        if (l.startsWith("data: ")) {
          const part = l.replace("data: ", "");

          if (part === "[STREAM_END]") {
            send.disabled = false;
            return;
          }

          full += part;
          target.textContent = full;
          chat.scrollTop = chat.scrollHeight;
        }
      }
    }

    send.disabled = false;
  }

  send.addEventListener("click", ask);
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      ask();
    }
  });
</script>

{% endblock %}
