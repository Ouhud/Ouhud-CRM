{% extends "base_dashboard.html" %}
{% block title %}‚öôÔ∏è KI Einstellungen{% endblock %}

{% block content %}

<style>
    .ai-box {
        max-width: 780px;
        margin: 20px auto;
        background: #ffffff;
        padding: 2rem;
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        border: 1px solid #e5e7eb;
        animation: fadeIn .35s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(12px); }
        to { opacity: 1; transform: translateY(0); }
    }

    h1 {
        font-size: 1.8rem;
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #0D2A78;
    }

    .subtitle {
        color: #6b7280;
        margin-bottom: 1.6rem;
        font-size: .98rem;
    }

    /* Form elements */
    label {
        font-weight: 600;
        margin-top: 1rem;
        display: block;
    }

    select, input[type="text"], input[type="password"] {
        width: 100%;
        padding: .7rem;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        background: #f9fafb;
        margin-top: .3rem;
        font-size: 1rem;
        transition: .2s ease;
    }

    select:focus, input:focus {
        background: #ffffff;
        border-color: #0D2A78;
        outline: none;
    }

    .api-field {
        display: flex;
        gap: .6rem;
        align-items: center;
    }

    .api-field button {
        padding: .6rem .8rem;
        border-radius: 8px;
        background: #e5e7eb;
        border: none;
        cursor: pointer;
    }

    .api-field button:hover {
        background: #d1d5db;
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 30px;
        margin-left: 10px;
    }
    .switch input { display: none; }

    .slider {
        position: absolute;
        cursor: pointer;
        background: #cfcfcf;
        border-radius: 30px;
        top: 0; left: 0; right: 0; bottom: 0;
        transition: .3s;
    }
    .slider:before {
        content: "";
        height: 26px;
        width: 26px;
        background: #ffffff;
        position: absolute;
        border-radius: 50%;
        top: 2px; left: 2px;
        transition: .3s;
    }
    input:checked + .slider {
        background: #10B981;
    }
    input:checked + .slider:before {
        transform: translateX(30px);
    }

    /* Buttons */
    .btn-primary {
        background: #0D2A78;
        color: white;
        padding: .75rem 1.2rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        margin-top: 1.5rem;
    }
    .btn-primary:hover {
        background: #1E40AF;
    }

    .btn-secondary {
        background: #059669;
        color: white;
        padding: .75rem 1.2rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        margin-top: 1rem;
    }
    .btn-secondary:hover {
        background: #047857;
    }

    /* Test result box */
    #test-result {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 8px;
        display: none;
        font-size: .95rem;
        white-space: pre-wrap;
        font-family: monospace;
    }

    .toast {
        background: #10B981;
        color: white;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 10px;
        animation: fadeIn .3s ease;
    }
</style>



<div class="ai-box">

    {% if request.query_params.get("success") == "1" %}
    <div class="toast">‚úî Einstellungen gespeichert</div>
    {% endif %}

    <h1>‚öôÔ∏è KI Einstellungen</h1>
    <p class="subtitle">W√§hle Provider, Modell, API-Key und aktiviere deinen AI-Assistenten.</p>

    <form method="post" action="/dashboard/ai/settings/save">

        <!-- Name -->
        <label>ü§ñ Assistentenname</label>
        <input type="text" name="assistant_name" value="{{ settings.assistant_name }}" required>

        <!-- Provider -->
        <label>üåê Anbieter</label>
        <select name="provider" id="provider-select">
            {% for p in providers.keys() %}
                <option value="{{ p }}" {% if settings.provider == p %}selected{% endif %}>
                    {{ p|capitalize }}
                </option>
            {% endfor %}
        </select>

        <!-- Model -->
        <label>üß¨ Modell</label>
        <select name="model" id="model-select">
            {% for m in providers[settings.provider] %}
            <option value="{{ m }}" {% if settings.model == m %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
        </select>

        <!-- API Key -->
        <label>üîë API-Key</label>
        <div class="api-field">
            <input type="password" id="api_key" name="api_key" value="{{ settings.api_key }}">
            <button type="button" id="toggle-key">üëÅ</button>
        </div>

        <!-- Aktiv -->
        <label style="margin-top:1rem;">AI aktivieren
            <label class="switch">
                <input type="checkbox" name="active" {% if settings.active %}checked{% endif %}>
                <span class="slider"></span>
            </label>
        </label>

        <button class="btn-primary">üíæ Speichern</button>
    </form>

    <button class="btn-secondary" onclick="testConnection()">üîå Verbindung testen</button>

    <div id="test-result"></div>

</div>



<script>
/* Toggle API Key visibility */
document.getElementById("toggle-key").onclick = () => {
    let f = document.getElementById("api_key");
    f.type = (f.type === "password") ? "text" : "password";
};

/* Provider ‚Üí update model list dynamically */
document.getElementById("provider-select").addEventListener("change", function () {
    const provider = this.value;
    const models = {{ providers | tojson }};
    const select = document.getElementById("model-select");

    select.innerHTML = "";
    models[provider].forEach(m => {
        select.innerHTML += `<option value="${m}">${m}</option>`;
    });
});

/* Test the connection to AI Provider */
async function testConnection() {
    const api_key = document.getElementById("api_key").value;
    const provider = document.getElementById("provider-select").value;

    const form = new FormData();
    form.append("api_key", api_key);
    form.append("provider", provider);

    const box = document.getElementById("test-result");
    box.style.display = "block";
    box.style.background = "#f3f4f6";
    box.innerText = "‚è≥ Test l√§uft...";

    let res = await fetch("/dashboard/ai/settings/test", { method: "POST", body: form });
    let result = await res.json();

    if (result.ok) {
        box.style.background = "#D1FAE5";
        box.innerText = "‚úî " + result.message;
    } else {
        box.style.background = "#FECACA";
        box.innerText = "‚ùå " + result.message;
    }
}
</script>

{% endblock %}