{% extends "base_dashboard.html" %}
{% block title %}ðŸ“¢ Kampagnen{% endblock %}

{% block content %}
<div class="campaigns-container">
  <h1>ðŸ“¢ Marketing-Kampagnen</h1>
  <p class="subtitle">Verwalte aktive, geplante und abgeschlossene Kampagnen.</p>

  <!-- ðŸ” Filter / Suche -->
  <form method="get" action="/dashboard/campaigns" class="filter-form">
    <input type="text" name="q" placeholder="ðŸ” Kampagnenname suchen..."
           value="{{ request.query_params.get('q','') }}">
    <select name="status">
      <option value="">Alle Status</option>
      <option value="aktiv">Aktiv</option>
      <option value="abgeschlossen">Abgeschlossen</option>
      <option value="geplant">Geplant</option>
    </select>
    <button type="submit" class="btn-primary">Filtern</button>
  </form>

  <!-- âž• Neue Kampagne -->
  <form method="post" action="/dashboard/campaigns/create" class="create-form">
    <input type="text" name="name" placeholder="Name der Kampagne" required>
    <input type="text" name="description" placeholder="Beschreibung (optional)">
    <button type="submit" class="btn-success">âž• Erstellen</button>
  </form>

  <!-- ðŸ“‹ Kampagnen-Tabelle -->
  <div class="table-wrapper">
    <table id="campaign-table">
      <thead>
        <tr>
          <th class="sortable" data-sort="id">#</th>
          <th class="sortable" data-sort="name">Name</th>
          <th>Status</th>
          <th class="sortable" data-sort="created">Erstellt am</th>
          <th>ðŸ“Š Statistik</th>
          <th>Aktionen</th>
        </tr>
      </thead>
      <tbody>
        {% if campaigns %}
          {% for c in campaigns %}
          <tr>
            <td>{{ c.id }}</td>
            <td>{{ c.name }}</td>
            <td>
              <form method="post" action="/dashboard/campaigns/update_status" style="display:inline;">
                <input type="hidden" name="id" value="{{ c.id }}">
                <select name="status" class="status-select" onchange="this.form.submit()">
                  <option value="aktiv" {% if c.status == 'aktiv' %}selected{% endif %}>Aktiv</option>
                  <option value="abgeschlossen" {% if c.status == 'abgeschlossen' %}selected{% endif %}>Abgeschlossen</option>
                  <option value="geplant" {% if c.status == 'geplant' %}selected{% endif %}>Geplant</option>
                </select>
              </form>
            </td>
            <td>{{ c.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
            <td>
              ðŸ“© {{ c.stats.recipients or 0 }} EmpfÃ¤nger<br>
              ðŸ“¨ {{ c.stats.sent or 0 }} gesendet â€¢ ðŸ“ˆ {{ c.stats.open_rate or 0 }} %
            </td>
            <td class="actions">
              <form method="post" action="/dashboard/campaigns/delete" style="display:inline;">
                <input type="hidden" name="id" value="{{ c.id }}">
                <button type="submit" class="btn-danger">ðŸ—‘ LÃ¶schen</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="6" class="empty-row">ðŸ“­ Keine Kampagnen vorhanden</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- ðŸ§­ Pagination -->
  <div class="pagination" id="pagination"></div>
</div>

<style>
  :root {
    --primary: #0D2A78;
    --primary-dark: #1E40AF;
    --success: #10B981;
    --danger: #DC2626;
    --border: #e5e7eb;
    --bg: #f9fafb;
    --text: #1f2937;
  }

  .campaigns-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 1rem;
  }

  h1 {
    font-size: 1.7rem;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 0.3rem;
  }

  .subtitle {
    color: #6b7280;
    margin-bottom: 1rem;
  }

  /* Filter + Form */
  .filter-form,
  .create-form {
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem;
    margin-bottom: 1rem;
  }

  .filter-form input,
  .filter-form select,
  .create-form input {
    flex: 1 1 220px;
    padding: 0.6rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: #fff;
  }

  .btn-primary,
  .btn-success,
  .btn-danger {
    border: none;
    border-radius: 8px;
    padding: 0.6rem 1rem;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.25s ease;
  }

  .btn-primary { background: var(--primary); }
  .btn-primary:hover { background: var(--primary-dark); }
  .btn-success { background: var(--success); }
  .btn-success:hover { background: #059669; }
  .btn-danger { background: var(--danger); }
  .btn-danger:hover { background: #b91c1c; }

  /* Tabelle */
  .table-wrapper {
    background: #fff;
    border-radius: 12px;
    overflow-x: auto;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
  }

  th, td {
    padding: 0.75rem 0.9rem;
    text-align: left;
    border-bottom: 1px solid var(--border);
  }

  thead {
    background: #f3f4f6;
    color: var(--text);
  }

  tbody tr:hover {
    background: #f9fafb;
  }

  .sortable {
    cursor: pointer;
  }

  .status-select {
    padding: 0.35rem 0.5rem;
    border-radius: 6px;
    border: 1px solid var(--border);
    font-size: 0.85rem;
  }

  .actions { white-space: nowrap; }

  .empty-row {
    text-align: center;
    padding: 1rem;
    color: #6b7280;
  }

  /* Pagination */
  .pagination {
    display: flex;
    justify-content: center;
    margin-top: 1rem;
    gap: 0.4rem;
  }

  .pagination button {
    background: #fff;
    border: 1px solid var(--border);
    padding: 0.4rem 0.7rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
  }

  .pagination button.active {
    background: var(--primary);
    color: #fff;
    border-color: var(--primary);
  }

  @media (max-width: 700px) {
    .filter-form, .create-form { flex-direction: column; }
    table { font-size: 0.9rem; }
  }
</style>

<script>
  // ðŸ“… Sortierung
  document.querySelectorAll('th.sortable').forEach(th => {
    th.addEventListener('click', () => {
      const table = document.getElementById('campaign-table');
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const asc = th.classList.toggle('asc');
      const idx = th.cellIndex;
      rows.sort((a, b) => {
        const va = a.children[idx].innerText.trim();
        const vb = b.children[idx].innerText.trim();
        return asc ? va.localeCompare(vb) : vb.localeCompare(va);
      });
      rows.forEach(r => tbody.appendChild(r));
    });
  });

  // ðŸ§­ Pagination
  const rowsPerPage = 10;
  const tbody = document.querySelector('#campaign-table tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const pagination = document.getElementById('pagination');

  function showPage(page) {
    rows.forEach((r, i) => {
      r.style.display = (i >= (page-1)*rowsPerPage && i < page*rowsPerPage) ? '' : 'none';
    });
    pagination.querySelectorAll('button').forEach((btn, idx) => {
      btn.classList.toggle('active', idx+1 === page);
    });
  }

  function setupPagination() {
    const pageCount = Math.ceil(rows.length / rowsPerPage);
    pagination.innerHTML = '';
    for (let i = 1; i <= pageCount; i++) {
      const btn = document.createElement('button');
      btn.innerText = i;
      btn.addEventListener('click', () => showPage(i));
      pagination.appendChild(btn);
    }
    if (pageCount > 0) showPage(1);
  }

  setupPagination();
</script>
{% endblock %}