{% extends "base.html" %}
{% block title %}ðŸ“¢ Kampagnen{% endblock %}

{% block content %}
<style>
  .table-container {
    overflow-x: auto;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    margin-top: 1rem;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
  }

  thead {
    background: #f3f4f6;
  }

  th, td {
    padding: .6rem .5rem;
    text-align: left;
  }

  th.sortable {
    cursor: pointer;
  }

  tr:nth-child(even) {
    background: #f9fafb;
  }

  tr:hover {
    background: #eef2ff;
  }

  .pagination {
    display: flex;
    justify-content: center;
    margin-top: 1rem;
    gap: .3rem;
  }

  .pagination button {
    background: #fff;
    border: 1px solid #ccc;
    padding: .3rem .6rem;
    border-radius: 4px;
    cursor: pointer;
  }

  .pagination button.active {
    background: #4f46e5;
    color: white;
    border-color: #4f46e5;
  }

  .status-select {
    padding: .3rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: .85rem;
  }
</style>

<div style="max-width:1000px;margin:0 auto;">
  <h1 style="font-size:1.7rem;font-weight:700;margin-bottom:1rem;">ðŸ“¢ Marketing-Kampagnen</h1>

  <!-- ðŸ” Filter / Suchfeld -->
  <form method="get" action="/dashboard/campaigns" style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1rem;">
    <input type="text" name="q" placeholder="ðŸ” Kampagnenname suchen..."
      value="{{ request.query_params.get('q','') }}"
      style="flex:1;min-width:220px;padding:.6rem;border:1px solid #ccc;border-radius:6px;">
    <select name="status" style="padding:.6rem;border:1px solid #ccc;border-radius:6px;">
      <option value="">Alle Status</option>
      <option value="aktiv">Aktiv</option>
      <option value="abgeschlossen">Abgeschlossen</option>
      <option value="geplant">Geplant</option>
    </select>
    <button type="submit" style="background:#4f46e5;color:white;padding:.6rem 1rem;border:none;border-radius:6px;cursor:pointer;">Filtern</button>
  </form>

  <!-- âž• Neue Kampagne -->
  <form method="post" action="/dashboard/campaigns/create" style="margin-bottom:1.5rem;display:flex;flex-wrap:wrap;gap:.5rem;">
    <input type="text" name="name" placeholder="Name der Kampagne" required
      style="flex:1;min-width:180px;padding:.6rem;border:1px solid #ccc;border-radius:6px;">
    <input type="text" name="description" placeholder="Beschreibung"
      style="flex:2;min-width:250px;padding:.6rem;border:1px solid #ccc;border-radius:6px;">
    <button type="submit" style="background:#4f46e5;color:white;padding:.6rem 1rem;border:none;border-radius:6px;cursor:pointer;">Erstellen</button>
  </form>

  <!-- ðŸ“‹ Kampagnen-Tabelle -->
  <div class="table-container">
    <table id="campaign-table">
      <thead>
        <tr>
          <th class="sortable" data-sort="id">#</th>
          <th class="sortable" data-sort="name">Name</th>
          <th class="sortable" data-sort="status">Status</th>
          <th class="sortable" data-sort="created">Erstellt am</th>
          <th>ðŸ“Š Statistik</th>
          <th>Aktionen</th>
        </tr>
      </thead>
      <tbody>
        {% if campaigns %}
          {% for c in campaigns %}
          <tr>
            <td>{{ c.id }}</td>
            <td>{{ c.name }}</td>
            <td>
              <!-- âœï¸ Status bearbeiten -->
              <form method="post" action="/dashboard/campaigns/update_status" style="display:inline;">
                <input type="hidden" name="id" value="{{ c.id }}">
                <select name="status" class="status-select" onchange="this.form.submit()">
                  <option value="aktiv" {% if c.status == 'aktiv' %}selected{% endif %}>Aktiv</option>
                  <option value="abgeschlossen" {% if c.status == 'abgeschlossen' %}selected{% endif %}>Abgeschlossen</option>
                  <option value="geplant" {% if c.status == 'geplant' %}selected{% endif %}>Geplant</option>
                </select>
              </form>
            </td>
            <td>{{ c.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
            <td>
              ðŸ“© {{ c.stats.recipients or 0 }} <br>
              ðŸ“¨ {{ c.stats.sent or 0 }} â€¢ ðŸ“ˆ {{ c.stats.open_rate or 0 }}%
            </td>
            <td>
              <form method="post" action="/dashboard/campaigns/delete" style="display:inline;">
                <input type="hidden" name="id" value="{{ c.id }}">
                <button type="submit" style="background:#ef4444;color:white;padding:.3rem .6rem;border:none;border-radius:4px;cursor:pointer;">LÃ¶schen</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="6" style="text-align:center;padding:1rem;">ðŸ“­ Keine Kampagnen vorhanden</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- ðŸ§­ Paginierung -->
  <div class="pagination" id="pagination"></div>
</div>

<script>
  // ðŸ“… Clientseitiges Sortieren
  document.querySelectorAll('th.sortable').forEach(th => {
    th.addEventListener('click', () => {
      const table = document.getElementById('campaign-table');
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const key = th.dataset.sort;
      const asc = th.classList.toggle('asc');

      rows.sort((a, b) => {
        const va = a.querySelector(`td:nth-child(${th.cellIndex+1})`).innerText;
        const vb = b.querySelector(`td:nth-child(${th.cellIndex+1})`).innerText;
        return asc ? va.localeCompare(vb) : vb.localeCompare(va);
      });

      rows.forEach(r => tbody.appendChild(r));
    });
  });

  // ðŸ§­ Clientseitige Paginierung
  const rowsPerPage = 10;
  const table = document.getElementById('campaign-table');
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const pagination = document.getElementById('pagination');

  function showPage(page) {
    rows.forEach((row, i) => {
      row.style.display = (i >= (page-1)*rowsPerPage && i < page*rowsPerPage) ? '' : 'none';
    });
    pagination.querySelectorAll('button').forEach((btn, idx) => {
      btn.classList.toggle('active', idx+1 === page);
    });
  }

  function setupPagination() {
    const pageCount = Math.ceil(rows.length / rowsPerPage);
    pagination.innerHTML = '';
    for (let i = 1; i <= pageCount; i++) {
      const btn = document.createElement('button');
      btn.innerText = i;
      btn.addEventListener('click', () => showPage(i));
      pagination.appendChild(btn);
    }
    if (pageCount > 0) showPage(1);
  }

  setupPagination();
</script>
{% endblock %}