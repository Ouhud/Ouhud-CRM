{% extends "base_dashboard.html" %}
{% block title %}üì≤ WhatsApp Chat ‚Äì Ouhud CRM{% endblock %}

{% block content %}
<style>
  :root {
    --primary: #0D2A78;
    --primary-dark: #1E40AF;
    --success: #10B981;
    --warning: #f59e0b;
    --danger: #dc2626;
    --border: #e5e7eb;
    --text: #1f2937;
    --muted: #6b7280;
    --bg: #f4f6f8;
  }

  .card {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 14px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.05);
  }

  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: .75rem;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(135deg, var(--primary-dark), var(--primary));
    color: #fff;
  }

  .title {
    display: flex;
    align-items: center;
    gap: .6rem;
    font-weight: 700;
    font-size: 1.1rem;
  }

  .status-pill {
    font-size: .8rem;
    padding: .25rem .6rem;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.3);
    background: rgba(255,255,255,0.15);
    color: #fff;
  }
  .status-pill.connected {
    background: #d1fae5;
    color: #065f46;
    border-color: #a7f3d0;
  }
  .status-pill.disconnected {
    background: #fee2e2;
    color: #991b1b;
    border-color: #fecaca;
  }

  .content {
    padding: 1.25rem 1.5rem;
  }

  .alert {
    display: flex;
    align-items: flex-start;
    gap: .75rem;
    background: #fff7ed;
    border: 1px solid #fed7aa;
    color: #7c2d12;
    border-radius: 10px;
    padding: .9rem 1rem;
    margin-bottom: 1rem;
  }

  .actions {
    display: flex;
    gap: .6rem;
  }

  .btn {
    appearance: none;
    border: 1px solid var(--border);
    background: #fff;
    color: var(--text);
    padding: .6rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: .95rem;
    font-weight: 500;
    transition: background 0.25s, transform 0.1s;
  }
  .btn-primary {
    background: var(--primary);
    color: #fff;
    border-color: var(--primary);
  }
  .btn-success {
    background: var(--success);
    color: #fff;
    border-color: var(--success);
  }
  .btn:hover {
    filter: brightness(.98);
    transform: translateY(-1px);
  }

  /* Chat area */
  .chat-wrap {
    display: grid;
    grid-template-rows: 1fr auto;
    gap: .8rem;
    height: 65vh;
    min-height: 460px;
  }

  .chat-box {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem;
    overflow-y: auto;
  }

  .msg {
    margin: .5rem 0;
    max-width: 80%;
  }
  .msg .meta {
    font-size: .74rem;
    color: var(--muted);
    display: flex;
    justify-content: space-between;
    gap: .5rem;
  }
  .msg .bubble {
    padding: .7rem .9rem;
    border-radius: 12px;
    margin-top: .25rem;
    word-wrap: break-word;
    border: 1px solid var(--border);
    background: #fff;
  }
  .msg.agent { margin-left: auto; text-align: right; }
  .msg.agent .bubble {
    background: #e0f2fe;
    border-color: #bae6fd;
    color: #075985;
  }
  .msg.customer .bubble {
    background: #ecfdf5;
    border-color: #bbf7d0;
    color: #064e3b;
  }

  .send-form {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: .6rem;
  }
  .send-form .row {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: .6rem;
  }
  .send-form input[type="text"] {
    width: 100%;
    padding: .7rem .9rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: .95rem;
  }
  .send-form input:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 2px rgba(13, 42, 120, 0.1);
  }

  .muted {
    color: var(--muted);
    font-size: .9rem;
  }

  @media (max-width: 800px) {
    .send-form .row { grid-template-columns: 1fr; }
    .chat-wrap { height: 58vh; }
  }
</style>

<div class="dashboard-container" style="max-width:1000px;margin:0 auto;">
  <div class="card">
    <div class="header">
      <div class="title">
        üì≤ WhatsApp Kundennachrichten
        <span id="wa-status" class="status-pill disconnected">Nicht verbunden</span>
      </div>
      <div class="actions">
        <a class="btn" href="/dashboard/whatsapp/connect">üîå Verbinden</a>
        <button id="refreshBtn" class="btn btn-primary">üîÑ Aktualisieren</button>
      </div>
    </div>

    <div class="content">
      <div id="notConnected" class="alert" style="display:none;">
        <div>‚ö†Ô∏è <strong>Nicht verbunden.</strong> Bitte verbinde deinen WhatsApp Business Account (Phone Number ID, Business ID, Access Token).</div>
        <div class="actions" style="margin-left:auto;">
          <a class="btn btn-success" href="/dashboard/whatsapp/connect">Jetzt verbinden</a>
        </div>
      </div>

      <div class="chat-wrap">
        <div id="whatsapp-box" class="chat-box">
          <div class="muted">Nachrichten werden geladen‚Ä¶</div>
        </div>

        <form id="whatsapp-form" class="send-form">
          <div class="row">
            <input id="whatsapp-to" type="text" placeholder="Empf√§ngernummer, z. B. +491701234567">
            <input id="whatsapp-text" type="text" placeholder="Nachricht eingeben‚Ä¶">
          </div>
          <button type="submit" class="btn btn-success">Senden</button>
        </form>
      </div>

      <div class="muted" style="margin-top:.6rem;">
        üí° Das System pr√ºft den Verbindungsstatus alle 5 Sekunden und l√§dt neue Nachrichten automatisch.
      </div>
    </div>
  </div>
</div>

<!-- JavaScript bleibt identisch -->
<script>
  const statusBadge = document.getElementById('wa-status');
  const notConnected = document.getElementById('notConnected');
  const box = document.getElementById('whatsapp-box');
  const form = document.getElementById('whatsapp-form');
  const toInput = document.getElementById('whatsapp-to');
  const textInput = document.getElementById('whatsapp-text');
  const refreshBtn = document.getElementById('refreshBtn');

  function setStatus(connected) {
    if (connected) {
      statusBadge.textContent = 'Verbunden';
      statusBadge.classList.add('connected');
      statusBadge.classList.remove('disconnected');
      notConnected.style.display = 'none';
      form.style.display = 'grid';
    } else {
      statusBadge.textContent = 'Nicht verbunden';
      statusBadge.classList.add('disconnected');
      statusBadge.classList.remove('connected');
      notConnected.style.display = 'flex';
      form.style.display = 'none';
    }
  }

  function renderMessages(msgs) {
    box.innerHTML = '';
    if (!msgs || !msgs.length) {
      box.innerHTML = '<div class="muted">üì≠ Keine Nachrichten vorhanden.</div>';
      return;
    }
    msgs.forEach(m => {
      const div = document.createElement('div');
      const isAgent = (m.from === 'Business');
      div.className = 'msg ' + (isAgent ? 'agent business' : 'customer');
      const time = m.time ? new Date(m.time).toLocaleTimeString() : '';
      div.innerHTML = `
        <div class="meta">
          <strong>${m.from}</strong>
          <span>${time}</span>
        </div>
        <div class="bubble">${m.text}</div>
      `;
      box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
  }

  async function fetchStatus() {
    try {
      const res = await fetch('/dashboard/whatsapp/status');
      const data = await res.json();
      setStatus(!!data.connected);
      return !!data.connected;
    } catch (e) {
      console.warn('Status-Fehler:', e);
      setStatus(false);
      return false;
    }
  }

  async function fetchMessages() {
    try {
      const res = await fetch('/dashboard/whatsapp/messages');
      const msgs = await res.json();
      renderMessages(msgs);
    } catch (e) {
      console.warn('Nachrichten-Fehler:', e);
    }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const to = toInput.value.trim();
    const text = textInput.value.trim();
    if (!to || !text) return;

    const fd = new FormData();
    fd.append('to', to);
    fd.append('text', text);

    try {
      const res = await fetch('/dashboard/whatsapp/send', { method: 'POST', body: fd });
      if (!res.ok) throw new Error('Send fehlgeschlagen');
      textInput.value = '';
      await fetchMessages();
    } catch {
      alert('Senden fehlgeschlagen. Bitte sp√§ter erneut versuchen.');
    }
  });

  refreshBtn.addEventListener('click', async () => {
    const connected = await fetchStatus();
    if (connected) await fetchMessages();
  });

  (async function init() {
    const connected = await fetchStatus();
    if (connected) await fetchMessages();
    setInterval(fetchStatus, 5000);
    setInterval(fetchMessages, 6000);
  })();

  // WebSocket
  const wsUrl = (location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/dashboard/whatsapp/ws';
  let ws;
  function initWebSocket() {
    ws = new WebSocket(wsUrl);
    ws.onopen = () => console.log('üü¢ WebSocket verbunden');
    ws.onmessage = e => renderIncomingMessage(JSON.parse(e.data));
    ws.onclose = () => setTimeout(initWebSocket, 3000);
  }
  function renderIncomingMessage(data) {
    const div = document.createElement('div');
    const isAgent = data.from === 'Business';
    div.className = 'msg ' + (isAgent ? 'agent business' : 'customer');
    const time = data.time ? new Date(data.time).toLocaleTimeString() : '';
    div.innerHTML = `
      <div class="meta"><strong>${data.from}</strong><span>${time}</span></div>
      <div class="bubble">${data.text}</div>
    `;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }
  initWebSocket();
</script>
{% endblock %}